# n8n Custom Node Development Rules for Cline

## Project Context

This is an n8n custom node starter repository. Use it to build n8n community nodes with TypeScript.

## Technology Stack

- Node.js v22+
- TypeScript 5.x (strict mode)
- n8n Node SDK
- @n8n/node-cli

## Development Commands

```bash
npm run dev      # Start n8n with hot reload
npm run build    # Build for production
npm run lint:fix # Auto-fix lint issues
```

## Architecture Choice

### Use DECLARATIVE for REST APIs:
- Reference: `nodes/GithubIssues/GithubIssues.node.ts`
- Uses `routing.send` for building HTTP requests
- Read: `docs/12-declarative-routing.md`

### Use PROGRAMMATIC for SDKs/Complex Logic:
- Reference: `nodes/Example/Example.node.ts`
- Custom `execute()` method
- Read: `docs/13-custom-execute-methods.md`

## File Structure

```
nodes/MyService/
├── MyService.node.ts        # Main entry
├── MyService.node.json      # Metadata
├── resources/user/          # Per-resource folder
│   ├── index.ts            # Operations
│   ├── create.ts           # Create fields
│   └── getAll.ts           # List + pagination
├── listSearch/             # Dynamic dropdowns
└── shared/
    ├── transport.ts        # API wrapper
    └── descriptions.ts     # UI components
```

## Critical Patterns

### API Key Credential

```typescript
export class MyServiceApi implements ICredentialType {
  name = 'myServiceApi';
  displayName = 'MyService API';
  properties: INodeProperties[] = [
    {
      displayName: 'API Key',
      name: 'apiKey',
      type: 'string',
      typeOptions: { password: true },
      default: '',
    },
  ];
  authenticate = {
    type: 'generic',
    properties: {
      headers: { Authorization: '=Bearer {{$credentials.apiKey}}' },
    },
  };
}
```

### SDK Execution Pattern

```typescript
async execute(this: IExecuteFunctions) {
  const credentials = await this.getCredentials('myApi');
  const client = new SDK(credentials.apiKey); // ONCE
  
  const items = this.getInputData();
  const returnData = [];
  
  for (let i = 0; i < items.length; i++) {
    try {
      const result = await client.op();
      returnData.push({ json: result, pairedItem: { item: i } });
    } catch (error) {
      if (this.continueOnFail()) {
        returnData.push({ json: { error: error.message }, pairedItem: { item: i } });
        continue;
      }
      throw new NodeOperationError(this.getNode(), error, { itemIndex: i });
    }
  }
  return [returnData];
}
```

## Common Mistakes

- ❌ Init SDK per item → ✅ Init ONCE before loop
- ❌ Forget pairedItem → ✅ Always include `pairedItem: { item: i }`
- ❌ Hardcode credentials → ✅ Use `this.getCredentials()`
- ❌ Skip error handling → ✅ Use `this.continueOnFail()` pattern

## Package.json Registration

```json
{
  "n8n": {
    "nodes": ["dist/nodes/MyService/MyService.node.js"],
    "credentials": ["dist/credentials/MyServiceApi.credentials.js"]
  }
}
```

## Key Documentation

- `docs/10-creating-your-first-node.md` - Getting started
- `docs/12-declarative-routing.md` - REST API nodes
- `docs/13-custom-execute-methods.md` - SDK nodes
- `docs/08-api-key-credentials.md` - API key auth
- `docs/25-preparing-for-publication.md` - Publishing
