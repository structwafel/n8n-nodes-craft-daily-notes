---
description: "n8n custom node development - applies when building nodes, credentials, or working with n8n SDK"
globs:
  - "nodes/**/*.ts"
  - "nodes/**/*.json"
  - "credentials/**/*.ts"
  - "**/*.node.ts"
  - "**/*.credentials.ts"
  - "!node_modules/**"
  - "!dist/**"
alwaysApply: false
---

# n8n Custom Node Development Rules

## Technology Stack

| Component | Version | Notes |
|-----------|---------|-------|
| Runtime | Node.js v22+ | LTS required |
| Language | TypeScript 5.x | strict mode enabled |
| Framework | n8n Node SDK | INodeType, ICredentialType |
| CLI | @n8n/node-cli | dev, build, lint, release |

---

## Architecture Decision

```
┌─────────────────────────────────────────────────────────────┐
│ Is it a REST API with standard CRUD operations?             │
│   YES → DECLARATIVE style                                   │
│   └─ Read: docs/12-declarative-routing.md                   │
│   └─ Reference: nodes/GithubIssues/GithubIssues.node.ts     │
├─────────────────────────────────────────────────────────────┤
│ Does it have an official SDK/client library?                │
│   YES → PROGRAMMATIC style                                  │
│   └─ Read: docs/13-custom-execute-methods.md                │
│   └─ Reference: nodes/Example/Example.node.ts               │
├─────────────────────────────────────────────────────────────┤
│ Is it GraphQL, WebSocket, or non-REST?                      │
│   YES → PROGRAMMATIC style                                  │
├─────────────────────────────────────────────────────────────┤
│ Complex authentication (request signing, multi-step)?       │
│   YES → PROGRAMMATIC style                                  │
└─────────────────────────────────────────────────────────────┘
```

---

## File Structure

### Declarative Node (Multi-Resource REST API)

```
nodes/MyService/
├── MyService.node.ts              # Main entry with requestDefaults
├── MyService.node.json            # Metadata (displayName, icon, etc.)
├── myservice.svg                  # Icon (SVG format preferred)
├── resources/                     # One folder per API resource
│   ├── user/
│   │   ├── index.ts              # Resource description + operations
│   │   ├── create.ts             # Create operation properties
│   │   ├── get.ts                # Get operation properties
│   │   ├── getAll.ts             # List operation + pagination
│   │   ├── update.ts             # Update operation properties
│   │   └── delete.ts             # Delete operation properties
│   └── project/
│       └── [same structure]
├── listSearch/                    # Dynamic dropdown methods
│   ├── getUsers.ts               # Search users for dropdown
│   └── getProjects.ts            # Search projects for dropdown
└── shared/
    ├── descriptions.ts            # Reusable UI components (resourceLocator)
    ├── transport.ts               # API request wrapper (apiRequest function)
    └── utils.ts                   # Helper functions
```

### Programmatic Node (Simple)

```
nodes/MyService/
├── MyService.node.ts              # Main entry with execute() method
├── MyService.node.json            # Metadata
└── myservice.svg                  # Icon
```

---

## Critical Patterns

### Pattern 1: Declarative Routing

```typescript
// Main node: nodes/MyService/MyService.node.ts
import type { INodeType, INodeTypeDescription } from 'n8n-workflow';
import { userDescription } from './resources/user';

export class MyService implements INodeType {
  description: INodeTypeDescription = {
    displayName: 'My Service',
    name: 'myService',
    icon: 'file:myservice.svg',
    group: ['transform'],
    version: 1,
    subtitle: '={{$parameter["operation"] + ": " + $parameter["resource"]}}',
    description: 'Interact with My Service API',
    defaults: { name: 'My Service' },
    inputs: ['main'],
    outputs: ['main'],
    credentials: [{ name: 'myServiceApi', required: true }],
    requestDefaults: {
      baseURL: 'https://api.myservice.com/v1',
      headers: { 'Content-Type': 'application/json' },
    },
    properties: [
      {
        displayName: 'Resource',
        name: 'resource',
        type: 'options',
        noDataExpression: true,
        options: [{ name: 'User', value: 'user' }],
        default: 'user',
      },
      ...userDescription,
    ],
  };
}
```

```typescript
// Resource: resources/user/create.ts
import type { INodeProperties } from 'n8n-workflow';

export const userCreateFields: INodeProperties[] = [
  {
    displayName: 'Name',
    name: 'name',
    type: 'string',
    required: true,
    default: '',
    displayOptions: { show: { resource: ['user'], operation: ['create'] } },
    routing: { send: { type: 'body', property: 'name' } },
  },
  {
    displayName: 'Email',
    name: 'email',
    type: 'string',
    placeholder: 'name@email.com',
    default: '',
    displayOptions: { show: { resource: ['user'], operation: ['create'] } },
    routing: { send: { type: 'body', property: 'email' } },
  },
];
```

### Pattern 2: Programmatic Execute

```typescript
import type { IExecuteFunctions, INodeExecutionData, INodeType } from 'n8n-workflow';
import { NodeOperationError } from 'n8n-workflow';

export class MyService implements INodeType {
  description = { /* ... */ };

  async execute(this: IExecuteFunctions): Promise<INodeExecutionData[][]> {
    // 1. Get credentials ONCE (before the loop)
    const credentials = await this.getCredentials('myServiceApi') as {
      apiKey: string;
      baseUrl?: string;
    };

    // 2. Initialize SDK/client ONCE
    const client = new MyServiceSDK(credentials.apiKey, {
      baseUrl: credentials.baseUrl || 'https://api.myservice.com',
    });

    // 3. Get input items
    const items = this.getInputData();
    const returnData: INodeExecutionData[] = [];

    // 4. Process each item
    for (let i = 0; i < items.length; i++) {
      try {
        const operation = this.getNodeParameter('operation', i) as string;
        const resource = this.getNodeParameter('resource', i) as string;

        let result: object;

        if (resource === 'user') {
          if (operation === 'create') {
            const name = this.getNodeParameter('name', i) as string;
            const email = this.getNodeParameter('email', i) as string;
            result = await client.users.create({ name, email });
          } else if (operation === 'get') {
            const userId = this.getNodeParameter('userId', i) as string;
            result = await client.users.get(userId);
          }
        }

        // 5. Always include pairedItem for data lineage
        returnData.push({
          json: result!,
          pairedItem: { item: i },
        });
      } catch (error) {
        // 6. Handle errors with continueOnFail
        if (this.continueOnFail()) {
          returnData.push({
            json: { error: (error as Error).message },
            pairedItem: { item: i },
          });
          continue;
        }
        throw new NodeOperationError(this.getNode(), error as Error, { itemIndex: i });
      }
    }

    return [returnData];
  }
}
```

### Pattern 3: API Key Credential

```typescript
// credentials/MyServiceApi.credentials.ts
import type { ICredentialType, INodeProperties, IAuthenticateGeneric } from 'n8n-workflow';

export class MyServiceApi implements ICredentialType {
  name = 'myServiceApi';
  displayName = 'My Service API';
  documentationUrl = 'https://docs.myservice.com/api-keys';
  
  properties: INodeProperties[] = [
    {
      displayName: 'API Key',
      name: 'apiKey',
      type: 'string',
      typeOptions: { password: true },
      default: '',
      required: true,
    },
    {
      displayName: 'Base URL',
      name: 'baseUrl',
      type: 'string',
      default: 'https://api.myservice.com',
      description: 'Override for self-hosted instances',
    },
  ];

  authenticate: IAuthenticateGeneric = {
    type: 'generic',
    properties: {
      headers: {
        Authorization: '=Bearer {{$credentials.apiKey}}',
      },
    },
  };
}
```

---

## Routing Types Reference

| Type | Purpose | Example |
|------|---------|---------|
| `routing.send.type: 'body'` | Send as request body property | `{ send: { type: 'body', property: 'name' } }` |
| `routing.send.type: 'query'` | Send as URL query parameter | `{ send: { type: 'query', property: 'limit' } }` |
| `routing.send.type: 'header'` | Send as HTTP header | `{ send: { type: 'header', property: 'X-Custom' } }` |
| `routing.send.value` | Transform before sending | `{ send: { value: '={{ $value.toUpperCase() }}' } }` |
| `routing.output.maxResults` | Limit returned items | `{ output: { maxResults: '={{$value}}' } }` |

---

## Common Mistakes

| ❌ DON'T | ✅ DO | Doc Reference |
|----------|-------|---------------|
| Initialize SDK per item | Initialize SDK ONCE before loop | `docs/13-custom-execute-methods.md` |
| Forget `pairedItem` | Always include `pairedItem: { item: i }` | `docs/13-custom-execute-methods.md` |
| Hardcode credentials | Use `this.getCredentials()` | `docs/07-credentials-system-overview.md` |
| Skip error handling | Use `this.continueOnFail()` pattern | `docs/17-error-handling-patterns.md` |
| Use `any` types | Define TypeScript interfaces | `docs/03-typescript-configuration.md` |
| Single large file | Split into resources/operations | `docs/11-resources-and-operations.md` |

---

## Documentation Reference

| Category | Files |
|----------|-------|
| **Getting Started** | `docs/00-documentation-index.md`, `docs/01-project-structure-overview.md` |
| **Configuration** | `docs/02-package-json-configuration.md`, `docs/03-typescript-configuration.md` |
| **Node Architecture** | `docs/04-node-anatomy-and-architecture.md`, `docs/05-declarative-vs-programmatic-nodes.md` |
| **Properties & UI** | `docs/06-node-properties-reference.md`, `docs/15-resource-locators.md` |
| **Credentials** | `docs/07-credentials-system-overview.md`, `docs/08-api-key-credentials.md`, `docs/09-oauth2-credentials.md` |
| **Building Nodes** | `docs/10-creating-your-first-node.md`, `docs/11-resources-and-operations.md` |
| **Routing & Execution** | `docs/12-declarative-routing.md`, `docs/13-custom-execute-methods.md` |
| **Dynamic UI** | `docs/14-list-search-methods.md`, `docs/15-resource-locators.md` |
| **Data Handling** | `docs/16-pagination-handling.md`, `docs/17-error-handling-patterns.md` |
| **Utilities** | `docs/18-helper-functions-and-utilities.md`, `docs/19-external-sdk-integration.md` |
| **Branding** | `docs/20-icons-and-branding.md`, `docs/21-node-json-metadata.md` |
| **Development** | `docs/22-development-workflow.md`, `docs/23-testing-strategies.md`, `docs/24-linting-and-code-quality.md` |
| **Publishing** | `docs/25-preparing-for-publication.md`, `docs/26-publishing-to-npm.md`, `docs/27-n8n-cloud-verification.md` |
| **Examples** | `docs/28-complete-code-examples.md`, `docs/29-common-patterns-and-recipes.md` |
| **Help** | `docs/30-troubleshooting-guide.md` |

---

## Commands

```bash
npm install      # Install dependencies
npm run dev      # Development with hot reload (http://localhost:5678)
npm run build    # Compile TypeScript to dist/
npm run lint     # Check code quality
npm run lint:fix # Auto-fix lint issues
npm run release  # Create new release
```

---

## Package.json Registration

**CRITICAL**: All nodes and credentials MUST be registered:

```json
{
  "name": "n8n-nodes-myservice",
  "version": "1.0.0",
  "keywords": ["n8n-community-node-package"],
  "n8n": {
    "nodes": [
      "dist/nodes/MyService/MyService.node.js"
    ],
    "credentials": [
      "dist/credentials/MyServiceApi.credentials.js"
    ]
  }
}
```
